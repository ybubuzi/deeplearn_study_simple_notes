"""
TensorFlow æ·±åº¦å­¦ä¹ å…¥é—¨ç¤ºä¾‹ 4: ç®€å•æ—¶åºé¢„æµ‹ï¼ˆè¯¦ç»†æ³¨é‡Šç‰ˆï¼‰
ä¸“ä¸ºJSå’ŒJavaå¼€å‘è€…è®¾è®¡çš„æ—¶åºæ•°æ®å…¥é—¨

æ—¶åºæ•°æ®æ¦‚å¿µï¼š
- æ—¶åºæ•°æ®ï¼šæŒ‰æ—¶é—´é¡ºåºæ’åˆ—çš„æ•°æ®
- ç‰¹ç‚¹ï¼šå½“å‰å€¼ä¾èµ–äºå†å²å€¼
- ä¾‹å­ï¼šè‚¡ä»·ã€å¤©æ°”ã€é”€é‡ç­‰
- ç›®æ ‡ï¼šæ ¹æ®å†å²æ•°æ®é¢„æµ‹æœªæ¥
"""

# ==================== å¯¼å…¥åº“è¯¦è§£ ====================
import tensorflow as tf     # æ·±åº¦å­¦ä¹ æ¡†æ¶
import numpy as np         # æ•°å€¼è®¡ç®—åº“
import matplotlib.pyplot as plt  # ç»˜å›¾åº“

"""
matplotlib.pyplotï¼š
- Pythonçš„ç»˜å›¾åº“ï¼Œç±»ä¼¼äºExcelå›¾è¡¨åŠŸèƒ½
- pltæ˜¯çº¦å®šä¿—æˆçš„åˆ«å
- ç”¨äºå¯è§†åŒ–æ•°æ®å’Œç»“æœ
"""

# è®¾ç½®ä¸­æ–‡å­—ä½“ï¼ˆWindowsç³»ç»Ÿï¼‰
plt.rcParams['font.sans-serif'] = ['SimHei']  # é»‘ä½“å­—ä½“
plt.rcParams['axes.unicode_minus'] = False    # æ­£å¸¸æ˜¾ç¤ºè´Ÿå·

"""
plt.rcParamsï¼š
- matplotlibçš„é…ç½®å‚æ•°
- ç±»ä¼¼äºå…¨å±€è®¾ç½®
- ç¡®ä¿ä¸­æ–‡å­—ç¬¦æ­£å¸¸æ˜¾ç¤º
"""

print("TensorFlowç‰ˆæœ¬:", tf.__version__)
print("=" * 60)
print("ğŸ“ˆ ç®€å•æ—¶åºé¢„æµ‹å…¥é—¨")
print("=" * 60)

# ==================== å‡½æ•°å®šä¹‰è¯¦è§£ ====================
def create_stock_data(days=1000):
    """
    Pythonå‡½æ•°å®šä¹‰è¯­æ³•ï¼š
    - def å‡½æ•°å(å‚æ•°=é»˜è®¤å€¼):
    - ä¸‰å¼•å·å†…æ˜¯æ–‡æ¡£å­—ç¬¦ä¸²ï¼ˆdocstringï¼‰
    - ç±»ä¼¼äº Java çš„ Javadoc æˆ– JS çš„ JSDoc
    """
    
    # è®¾ç½®éšæœºç§å­ç¡®ä¿å¯é‡ç°
    np.random.seed(42)  
    
    # åˆ›å»ºåŸºç¡€è¶‹åŠ¿ï¼šä»100åˆ°150çš„çº¿æ€§å¢é•¿
    trend = np.linspace(100, 150, days)
    """
    np.linspace(start, stop, num)ï¼š
    - åœ¨startå’Œstopä¹‹é—´ç”Ÿæˆnumä¸ªç­‰é—´è·çš„æ•°
    - ç±»ä¼¼äºåˆ›å»ºä¸€ä¸ªç­‰å·®æ•°åˆ—
    - ä¾‹ï¼šnp.linspace(0, 10, 5) = [0, 2.5, 5, 7.5, 10]
    """
    
    # æ·»åŠ éšæœºæ³¢åŠ¨ï¼ˆå™ªå£°ï¼‰
    noise = np.random.normal(0, 5, days)
    """
    np.random.normal(å‡å€¼, æ ‡å‡†å·®, æ•°é‡)ï¼š
    - ç”Ÿæˆæ­£æ€åˆ†å¸ƒï¼ˆé«˜æ–¯åˆ†å¸ƒï¼‰çš„éšæœºæ•°
    - å‡å€¼0ï¼Œæ ‡å‡†å·®5ï¼Œç”Ÿæˆdaysä¸ªæ•°
    - æ¨¡æ‹ŸçœŸå®æ•°æ®ä¸­çš„éšæœºæ³¢åŠ¨
    """
    
    # æ·»åŠ å‘¨æœŸæ€§æ³¢åŠ¨ï¼ˆæ¨¡æ‹Ÿå¸‚åœºå‘¨æœŸï¼‰
    cycle = 10 * np.sin(np.linspace(0, 4*np.pi, days))
    """
    æ­£å¼¦å‡½æ•°åˆ›å»ºå‘¨æœŸæ€§æ¨¡å¼ï¼š
    - np.sin()ï¼šæ­£å¼¦å‡½æ•°
    - 4*np.piï¼š4Ï€ï¼Œè¡¨ç¤º2ä¸ªå®Œæ•´å‘¨æœŸ
    - ä¹˜ä»¥10ï¼šæŒ¯å¹…ä¸º10
    - æ¨¡æ‹Ÿè‚¡å¸‚çš„å‘¨æœŸæ€§æ³¢åŠ¨
    """
    
    # åˆæˆæœ€ç»ˆè‚¡ä»·
    stock_price = trend + cycle + noise
    """
    NumPyæ•°ç»„è¿ç®—ï¼š
    - ä¸‰ä¸ªæ•°ç»„å¯¹åº”ä½ç½®ç›¸åŠ 
    - trend[i] + cycle[i] + noise[i]
    - ç±»ä¼¼äºå‘é‡åŠ æ³•
    """
    
    return stock_price  # è¿”å›ç”Ÿæˆçš„è‚¡ä»·æ•°æ®

# ==================== æ•°æ®ç”Ÿæˆå’Œå¯è§†åŒ– ====================
print("\n1. ç”Ÿæˆæ¨¡æ‹Ÿè‚¡ä»·æ•°æ®...")

# è°ƒç”¨å‡½æ•°ç”Ÿæˆæ•°æ®
stock_prices = create_stock_data(1000)
"""
å‡½æ•°è°ƒç”¨ï¼š
- ç±»ä¼¼äº Java: double[] prices = createStockData(1000);
- ç±»ä¼¼äº JS: const prices = createStockData(1000);
"""

print(f"ç”Ÿæˆäº† {len(stock_prices)} å¤©çš„è‚¡ä»·æ•°æ®")
print(f"ä»·æ ¼èŒƒå›´: {stock_prices.min():.2f} - {stock_prices.max():.2f}")

"""
æ•°ç»„æ–¹æ³•ï¼š
- len(stock_prices)ï¼šè·å–æ•°ç»„é•¿åº¦
- stock_prices.min()ï¼šæœ€å°å€¼
- stock_prices.max()ï¼šæœ€å¤§å€¼
- :.2fï¼šæ ¼å¼åŒ–ä¸º2ä½å°æ•°
"""

# å¯è§†åŒ–å‰200å¤©çš„æ•°æ®
plt.figure(figsize=(12, 4))  # åˆ›å»ºå›¾å½¢ï¼Œè®¾ç½®å¤§å°
"""
matplotlibç»˜å›¾ï¼š
- plt.figure()ï¼šåˆ›å»ºæ–°å›¾å½¢
- figsize=(å®½, é«˜)ï¼šè®¾ç½®å›¾å½¢å¤§å°ï¼ˆè‹±å¯¸ï¼‰
"""

plt.plot(stock_prices[:200], label='è‚¡ä»·')  # ç»˜åˆ¶çº¿å›¾
"""
plt.plot()ï¼šç»˜åˆ¶çº¿å›¾
- stock_prices[:200]ï¼šå–å‰200ä¸ªæ•°æ®ç‚¹
- label='è‚¡ä»·'ï¼šå›¾ä¾‹æ ‡ç­¾
"""

plt.title('æ¨¡æ‹Ÿè‚¡ä»·æ•°æ®ï¼ˆå‰200å¤©ï¼‰')  # è®¾ç½®æ ‡é¢˜
plt.xlabel('å¤©æ•°')                    # xè½´æ ‡ç­¾
plt.ylabel('è‚¡ä»·')                    # yè½´æ ‡ç­¾
plt.legend()                         # æ˜¾ç¤ºå›¾ä¾‹
plt.grid(True)                       # æ˜¾ç¤ºç½‘æ ¼
plt.show()                          # æ˜¾ç¤ºå›¾å½¢

# ==================== æ—¶åºæ•°æ®é¢„å¤„ç†è¯¦è§£ ====================
print("\n2. å‡†å¤‡æ—¶åºè®­ç»ƒæ•°æ®...")

def create_sequences(data, seq_length):
    """
    å°†æ—¶åºæ•°æ®è½¬æ¢ä¸ºç›‘ç£å­¦ä¹ æ ¼å¼
    
    æ—¶åºé¢„æµ‹çš„æ ¸å¿ƒæ€æƒ³ï¼š
    - ç”¨è¿‡å»Nä¸ªæ—¶é—´ç‚¹çš„æ•°æ®é¢„æµ‹ä¸‹ä¸€ä¸ªæ—¶é—´ç‚¹
    - ç±»ä¼¼äºæ ¹æ®è¿‡å»å‡ å¤©çš„è‚¡ä»·é¢„æµ‹æ˜å¤©çš„è‚¡ä»·
    """
    
    # åˆå§‹åŒ–ç©ºåˆ—è¡¨å­˜å‚¨ç»“æœ
    X, y = [], []
    """
    Pythonåˆ—è¡¨åˆå§‹åŒ–ï¼š
    - []ï¼šç©ºåˆ—è¡¨
    - ç±»ä¼¼äº Java: List<Double> X = new ArrayList<>();
    - ç±»ä¼¼äº JS: const X = [];
    """
    
    # éå†æ•°æ®åˆ›å»ºåºåˆ—
    for i in range(len(data) - seq_length):
        """
        range()å‡½æ•°ï¼š
        - range(n)ï¼šç”Ÿæˆ0åˆ°n-1çš„æ•´æ•°åºåˆ—
        - ç±»ä¼¼äº Java: for(int i=0; i<n; i++)
        - ç±»ä¼¼äº JS: for(let i=0; i<n; i++)
        """
        
        # è¾“å…¥ï¼šè¿‡å»seq_lengthå¤©çš„ä»·æ ¼
        X.append(data[i:i + seq_length])
        """
        åˆ—è¡¨åˆ‡ç‰‡å’Œæ·»åŠ ï¼š
        - data[i:i + seq_length]ï¼šä»iåˆ°i+seq_lengthçš„æ•°æ®
        - .append()ï¼šæ·»åŠ åˆ°åˆ—è¡¨æœ«å°¾
        - ç±»ä¼¼äº Java: list.add()
        - ç±»ä¼¼äº JS: array.push()
        """
        
        # è¾“å‡ºï¼šä¸‹ä¸€å¤©çš„ä»·æ ¼
        y.append(data[i + seq_length])
    
    # è½¬æ¢ä¸ºNumPyæ•°ç»„
    return np.array(X), np.array(y)
    """
    np.array()ï¼š
    - å°†Pythonåˆ—è¡¨è½¬æ¢ä¸ºNumPyæ•°ç»„
    - NumPyæ•°ç»„æ”¯æŒé«˜æ•ˆçš„æ•°å­¦è¿ç®—
    - ç±»ä¼¼äºå°†ArrayListè½¬æ¢ä¸ºåŸç”Ÿæ•°ç»„
    """

# ä½¿ç”¨è¿‡å»10å¤©é¢„æµ‹ä¸‹ä¸€å¤©
sequence_length = 10
X, y = create_sequences(stock_prices, sequence_length)

"""
å¤šé‡èµ‹å€¼ï¼š
- Pythonå¯ä»¥åŒæ—¶èµ‹å€¼å¤šä¸ªå˜é‡
- ç±»ä¼¼äº Java: Pair<X,y> result = ...; X = result.first; y = result.second;
- ç±»ä¼¼äº JS: const [X, y] = createSequences(...);
"""

print(f"åºåˆ—é•¿åº¦: {sequence_length}")
print(f"è®­ç»ƒæ ·æœ¬æ•°: {len(X)}")
print(f"Xå½¢çŠ¶: {X.shape}")  # (æ ·æœ¬æ•°, åºåˆ—é•¿åº¦)
print(f"yå½¢çŠ¶: {y.shape}")  # (æ ·æœ¬æ•°,)

"""
æ•°ç»„å½¢çŠ¶ï¼š
- .shapeï¼šNumPyæ•°ç»„çš„å½¢çŠ¶å±æ€§
- X.shape = (990, 10)ï¼š990ä¸ªæ ·æœ¬ï¼Œæ¯ä¸ªæ ·æœ¬10ä¸ªæ—¶é—´æ­¥
- y.shape = (990,)ï¼š990ä¸ªç›®æ ‡å€¼
"""

# æ˜¾ç¤ºæ•°æ®ç¤ºä¾‹
print("\næ•°æ®ç¤ºä¾‹:")
for i in range(3):  # æ˜¾ç¤ºå‰3ä¸ªæ ·æœ¬
    print(f"æ ·æœ¬{i+1}: è¾“å…¥={X[i][:5]}... -> è¾“å‡º={y[i]:.2f}")
    """
    å­—ç¬¦ä¸²æ ¼å¼åŒ–ï¼š
    - X[i][:5]ï¼šå–ç¬¬iä¸ªæ ·æœ¬çš„å‰5ä¸ªå€¼
    - ...ï¼šçœç•¥å·è¡¨ç¤ºè¿˜æœ‰æ›´å¤šæ•°æ®
    - y[i]:.2fï¼šç›®æ ‡å€¼ä¿ç•™2ä½å°æ•°
    """

# ==================== æ•°æ®æ ‡å‡†åŒ–è¯¦è§£ ====================
print("\n3. æ•°æ®æ ‡å‡†åŒ–...")

# åˆ†å‰²è®­ç»ƒå’Œæµ‹è¯•é›†
train_size = int(0.8 * len(X))  # 80%ç”¨äºè®­ç»ƒ
"""
æ•°æ®åˆ†å‰²ï¼š
- int()ï¼šè½¬æ¢ä¸ºæ•´æ•°
- 0.8 * len(X)ï¼š80%çš„æ•°æ®é‡
- ç±»ä¼¼äºæœºå™¨å­¦ä¹ çš„æ ‡å‡†åšæ³•
"""

X_train, X_test = X[:train_size], X[train_size:]
y_train, y_test = y[:train_size], y[train_size:]
"""
æ•°ç»„åˆ‡ç‰‡åˆ†å‰²ï¼š
- X[:train_size]ï¼šä»å¼€å§‹åˆ°train_size
- X[train_size:]ï¼šä»train_sizeåˆ°ç»“æŸ
- ç±»ä¼¼äº Java: Arrays.copyOfRange()
"""

# è®¡ç®—æ ‡å‡†åŒ–å‚æ•°ï¼ˆåªç”¨è®­ç»ƒæ•°æ®ï¼‰
mean_price = X_train.mean()  # å¹³å‡å€¼
std_price = X_train.std()    # æ ‡å‡†å·®
"""
ç»Ÿè®¡å‡½æ•°ï¼š
- .mean()ï¼šè®¡ç®—å¹³å‡å€¼
- .std()ï¼šè®¡ç®—æ ‡å‡†å·®
- åªç”¨è®­ç»ƒæ•°æ®è®¡ç®—ï¼Œé¿å…æ•°æ®æ³„éœ²
"""

# åº”ç”¨æ ‡å‡†åŒ–
X_train_scaled = (X_train - mean_price) / std_price
X_test_scaled = (X_test - mean_price) / std_price
y_train_scaled = (y_train - mean_price) / std_price
y_test_scaled = (y_test - mean_price) / std_price

"""
æ ‡å‡†åŒ–å…¬å¼ï¼š
- (x - å‡å€¼) / æ ‡å‡†å·®
- å°†æ•°æ®è½¬æ¢ä¸ºå‡å€¼0ï¼Œæ ‡å‡†å·®1çš„åˆ†å¸ƒ
- å¸®åŠ©ç¥ç»ç½‘ç»œæ›´å¥½åœ°å­¦ä¹ 
- ç±»ä¼¼äºå°†ä¸åŒå•ä½çš„æ•°æ®ç»Ÿä¸€åˆ°ç›¸åŒèŒƒå›´
"""

print(f"è®­ç»ƒé›†å¤§å°: {len(X_train)}")
print(f"æµ‹è¯•é›†å¤§å°: {len(X_test)}")
print(f"æ•°æ®å‡å€¼: {mean_price:.2f}")
print(f"æ•°æ®æ ‡å‡†å·®: {std_price:.2f}")

# ==================== RNNæ¨¡å‹æ„å»ºè¯¦è§£ ====================
print("\n4. æ„å»ºRNNæ¨¡å‹...")

model = tf.keras.Sequential([
    # SimpleRNNå±‚ï¼šå¤„ç†æ—¶åºæ•°æ®çš„åŸºç¡€å±‚
    tf.keras.layers.SimpleRNN(
        50,                           # éšè—å•å…ƒæ•°ï¼šRNNçš„"è®°å¿†å®¹é‡"
        input_shape=(sequence_length, 1),  # è¾“å…¥å½¢çŠ¶ï¼š(æ—¶é—´æ­¥, ç‰¹å¾æ•°)
        name='rnn_layer'
    ),
    """
    SimpleRNNè¯¦è§£ï¼š
    - RNNï¼šå¾ªç¯ç¥ç»ç½‘ç»œï¼Œä¸“é—¨å¤„ç†åºåˆ—æ•°æ®
    - 50ï¼šéšè—å•å…ƒæ•°ï¼Œç±»ä¼¼äº"è®°å¿†ç»†èƒ"çš„æ•°é‡
    - input_shape=(10, 1)ï¼š10ä¸ªæ—¶é—´æ­¥ï¼Œæ¯æ­¥1ä¸ªç‰¹å¾
    - èƒ½å¤Ÿè®°ä½ä¹‹å‰çš„ä¿¡æ¯ï¼Œé€‚åˆæ—¶åºé¢„æµ‹
    """
    
    # è¾“å‡ºå±‚ï¼šé¢„æµ‹ä¸‹ä¸€ä¸ªä»·æ ¼
    tf.keras.layers.Dense(1, name='output_layer')
    """
    Denseå±‚ï¼š
    - å…¨è¿æ¥å±‚ï¼Œå°†RNNçš„è¾“å‡ºè½¬æ¢ä¸ºæœ€ç»ˆé¢„æµ‹
    - 1ï¼šè¾“å‡º1ä¸ªæ•°å€¼ï¼ˆä¸‹ä¸€å¤©çš„è‚¡ä»·ï¼‰
    """
])

# ç¼–è¯‘æ¨¡å‹
model.compile(
    optimizer='adam',    # Adamä¼˜åŒ–å™¨
    loss='mse',         # å‡æ–¹è¯¯å·®æŸå¤±
    metrics=['mae']     # å¹³å‡ç»å¯¹è¯¯å·®æŒ‡æ ‡
)

print("æ¨¡å‹ç»“æ„:")
model.summary()

"""
RNNæ¨¡å‹çš„å·¥ä½œåŸç†ï¼š
1. è¾“å…¥ï¼šè¿‡å»10å¤©çš„è‚¡ä»· [ä»·æ ¼1, ä»·æ ¼2, ..., ä»·æ ¼10]
2. RNNå±‚ï¼šé€æ­¥å¤„ç†æ¯ä¸ªæ—¶é—´æ­¥ï¼Œç´¯ç§¯è®°å¿†
3. è¾“å‡ºå±‚ï¼šåŸºäºç´¯ç§¯çš„è®°å¿†é¢„æµ‹ä¸‹ä¸€å¤©ä»·æ ¼
4. ç±»ä¼¼äºäººç±»æ ¹æ®å†å²è¶‹åŠ¿åšåˆ¤æ–­
"""
